---
title: "TNA Package: Complete Python vs R Equivalence Comparison"
author: "TNA Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: flatly
    code_folding: show
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 8
)


# Load reticulate for Python support
library(reticulate)
  py_install(c("numpy", "pandas", "matplotlib", "networkx", "scipy", "seaborn"))

```

# Introduction

This document provides a **comprehensive comparison** between the Python TNA package and the R TNA package. It covers:

1. **Data Loading** - Same dataset in both packages
2. **All Model Types** - tna(), ftna(), ctna(), atna(), and advanced types
3. **All Centrality Measures** - All 9 centrality measures
4. **Statistical Inference** - Bootstrap and permutation tests
5. **Visualization** - Side-by-side plotting comparisons
6. **Numerical Equivalence Summary** - Quantified differences

---

# Setup

## R Setup

```{r r-setup}
# Install TNA if not available
if (!requireNamespace("tna", quietly = TRUE)) {
  install.packages("tna")
}

library(tna)
library(qgraph)
library(igraph)
```

## Python Setup

```{python py-setup}
import numpy as np
import pandas as pd
import tna
import matplotlib.pyplot as plt

np.set_printoptions(precision=6, suppress=True)
pd.set_option('display.precision', 6)

print(f"Python TNA version: {tna.__version__}")
print(f"NumPy version: {np.__version__}")
print(f"Pandas version: {pd.__version__}")
```

---

# Data Loading

Both packages include the identical group regulation dataset.

## R: Load Data

```{r r-load-data}
# Load the group regulation dataset
data("group_regulation", package = "tna")

cat("R Dataset Dimensions:", dim(group_regulation), "\n")
cat("Number of sequences:", nrow(group_regulation), "\n")
cat("Number of time steps:", ncol(group_regulation), "\n")
cat("\nUnique states:\n")
print(sort(unique(unlist(group_regulation))))
```

## Python: Load Data

```{python py-load-data}
# Load the group regulation dataset
df = tna.load_group_regulation()

print(f"Python Dataset Dimensions: {df.shape}")
print(f"Number of sequences: {df.shape[0]}")
print(f"Number of time steps: {df.shape[1]}")
print(f"\nUnique states:")
print(sorted(df.stack().dropna().unique()))
```

## Data Verification

```{python py-verify-data}
# Compare dimensions
import numpy as np
r_shape = (r.group_regulation.shape[0], r.group_regulation.shape[1])
py_shape = df.shape
print(f"Data equivalence check:")
print(f"  R dimensions: {r_shape}")
print(f"  Python dimensions: {py_shape}")
print(f"  Same dimensions: {r_shape == py_shape}")
```

---

# Model Building Comparison

## Standard TNA Model (Relative Probabilities)

### R: TNA Model

```{r r-tna-model}
model_r <- tna(group_regulation)

cat("R Model Summary:\n")
cat("  Type:", model_r$type, "\n")
cat("  States:", paste(model_r$labels, collapse = ", "), "\n")
cat("  Non-zero edges:", sum(model_r$weights > 0), "\n")

cat("\nTransition Matrix (rounded to 4 decimals):\n")
print(round(model_r$weights, 4))
```

### Python: TNA Model

```{python py-tna-model}
model_py = tna.tna(df)

print("Python Model Summary:")
print(f"  Type: {model_py.type_}")
print(f"  States: {', '.join(model_py.labels)}")
print(f"  Non-zero edges: {np.sum(model_py.weights > 0)}")

print("\nTransition Matrix (rounded to 4 decimals):")
print(model_py.to_dataframe().round(4))
```

### Numerical Comparison: TNA

```{python compare-tna}
import numpy as np

# Get R weights matrix
r_weights = np.array(r.model_r["weights"])
py_weights = model_py.weights

diff_tna = np.abs(r_weights - py_weights)
print("TNA Model Comparison:")
print(f"  Maximum absolute difference: {diff_tna.max():.2e}")
print(f"  Mean absolute difference: {diff_tna.mean():.2e}")
print(f"  Matrices equivalent (diff < 1e-10): {diff_tna.max() < 1e-10}")
```

---

## Frequency Model (FTNA)

### R: FTNA

```{r r-ftna}
ftna_r <- ftna(group_regulation)

cat("R FTNA Summary:\n")
cat("  Total transitions:", sum(ftna_r$weights), "\n")
cat("  Max weight:", max(ftna_r$weights), "\n")
cat("\nFrequency Matrix (first 5x5):\n")
print(ftna_r$weights[1:5, 1:5])
```

### Python: FTNA

```{python py-ftna}
ftna_py = tna.ftna(df)

print("Python FTNA Summary:")
print(f"  Total transitions: {ftna_py.weights.sum():.0f}")
print(f"  Max weight: {ftna_py.weights.max():.0f}")
print("\nFrequency Matrix (first 5x5):")
print(ftna_py.to_dataframe().iloc[:5, :5])
```

### Numerical Comparison: FTNA

```{python compare-ftna}
r_ftna_weights = np.array(r.ftna_r["weights"])
py_ftna_weights = ftna_py.weights

diff_ftna = np.abs(r_ftna_weights - py_ftna_weights)
print("FTNA Model Comparison:")
print(f"  Maximum absolute difference: {diff_ftna.max():.2e}")
print(f"  Matrices equivalent: {diff_ftna.max() < 1e-10}")
```

---

## Co-occurrence Model (CTNA)

### R: CTNA

```{r r-ctna}
ctna_r <- ctna(group_regulation)

cat("R CTNA Summary:\n")
cat("  Type:", ctna_r$type, "\n")
cat("  Row sums (should be 1):\n")
print(round(rowSums(ctna_r$weights), 4))
```

### Python: CTNA

```{python py-ctna}
ctna_py = tna.ctna(df)

print("Python CTNA Summary:")
print(f"  Type: {ctna_py.type_}")
print("  Row sums (should be 1):")
print(ctna_py.weights.sum(axis=1).round(4))
```

### Numerical Comparison: CTNA

```{python compare-ctna}
r_ctna_weights = np.array(r.ctna_r["weights"])
py_ctna_weights = ctna_py.weights

diff_ctna = np.abs(r_ctna_weights - py_ctna_weights)
print("CTNA Model Comparison:")
print(f"  Maximum absolute difference: {diff_ctna.max():.2e}")
print(f"  Matrices equivalent: {diff_ctna.max() < 1e-10}")
```

---

## Attention Model (ATNA)

### R: ATNA

```{r r-atna}
# R doesn't have a direct atna() function, but uses type = "attention"
# Check if attention type is available
if ("attention" %in% c("relative", "frequency", "co-occurrence")) {
  cat("Attention type not directly available in R tna\n")
} else {
  cat("Testing attention model with beta = 0.1\n")
}
```

### Python: ATNA

```{python py-atna}
atna_py = tna.atna(df, beta=0.1)

print("Python ATNA Summary:")
print(f"  Type: {atna_py.type_}")
print(f"  Row sums (should be 1): {atna_py.weights.sum(axis=1).round(4)}")
print("\nAttention Matrix (first 3x3):")
print(atna_py.to_dataframe().iloc[:3, :3].round(4))
```

---

## Additional Model Types (Python)

```{python py-additional-models}
# Python supports additional model types
print("Additional Python Model Types:")

# N-gram model
ngram_model = tna.build_model(df, type_='n-gram', params={'n': 2})
print(f"\n1. N-gram (n=2): {ngram_model.type_}")
print(f"   Row sums: {ngram_model.weights.sum(axis=1).round(4)}")

# Gap model
gap_model = tna.build_model(df, type_='gap', params={'max_gap': 3, 'decay': 0.5})
print(f"\n2. Gap (max_gap=3, decay=0.5): {gap_model.type_}")
print(f"   Row sums: {gap_model.weights.sum(axis=1).round(4)}")

# Window model
window_model = tna.build_model(df, type_='window', params={'size': 3})
print(f"\n3. Window (size=3): {window_model.type_}")
print(f"   Row sums: {window_model.weights.sum(axis=1).round(4)}")

# Reverse model
reverse_model = tna.build_model(df, type_='reverse')
print(f"\n4. Reverse: {reverse_model.type_}")
print(f"   Row sums: {reverse_model.weights.sum(axis=1).round(4)}")
```

---

# Centrality Measures Comparison

## R: All Centralities

```{r r-centralities}
cent_r <- centralities(model_r)

cat("R Centrality Measures:\n")
cent_r_display <- cent_r
cent_r_display[, -1] <- round(cent_r_display[, -1], 4)
print(cent_r_display)
```

## Python: All Centralities

```{python py-centralities}
cent_py = tna.centralities(model_py)

print("Python Centrality Measures:")
print(cent_py.round(4))
```

## Measure-by-Measure Comparison

```{python compare-centralities-detail}
import pandas as pd

# Get R centralities as numpy arrays
r_cent_data = {}
measures = ['OutStrength', 'InStrength', 'ClosenessIn', 'ClosenessOut',
            'Closeness', 'Betweenness', 'BetweennessRSP', 'Diffusion', 'Clustering']

for m in measures:
    r_cent_data[m] = np.array(r.cent_r[m])

print("Centrality Measure Comparison:")
print("=" * 70)

results = []
for m in measures:
    r_vals = r_cent_data[m]
    py_vals = cent_py[m].values

    diff = np.abs(r_vals - py_vals)
    max_diff = diff.max()
    mean_diff = diff.mean()
    corr = np.corrcoef(r_vals, py_vals)[0, 1]

    results.append({
        'Measure': m,
        'Max_Diff': max_diff,
        'Mean_Diff': mean_diff,
        'Correlation': corr,
        'Equivalent': max_diff < 1e-6
    })

    print(f"\n{m}:")
    print(f"  Max absolute difference: {max_diff:.2e}")
    print(f"  Mean absolute difference: {mean_diff:.2e}")
    print(f"  Correlation: {corr:.6f}")
    print(f"  Equivalent (diff < 1e-6): {max_diff < 1e-6}")

print("\n\nSummary Table:")
print(pd.DataFrame(results).to_string(index=False))
```

## Individual Centrality Values

```{python compare-individual-centralities}
states = list(model_py.labels)

for measure in ['OutStrength', 'InStrength', 'Diffusion', 'Clustering']:
    r_vals = r_cent_data[measure]
    py_vals = cent_py[measure].values

    print(f"\n{measure} Comparison:")
    print(f"{'State':<12} {'R':>12} {'Python':>12} {'Diff':>12}")
    print("-" * 50)
    for i, state in enumerate(states):
        print(f"{state:<12} {r_vals[i]:12.6f} {py_vals[i]:12.6f} {abs(r_vals[i] - py_vals[i]):12.2e}")
```

---

# Statistical Inference

## Bootstrap: R vs Python

```{r r-bootstrap}
set.seed(42)
boot_r <- bootstrap(model_r, iter = 1000)

cat("R Bootstrap (iter=1000):\n")
cat("  Significant edges:", sum(boot_r$weights_sig > 0), "\n")

cat("\nR Significance Matrix (weights_sig):\n")
print(round(boot_r$weights_sig, 4))
```

```{python py-bootstrap}
boot = tna.bootstrap_tna(model_py, iter=1000, seed=42)

print(f"Python Bootstrap (iter={boot.iter}):")
print(f"  Significant edges: {int((boot.weights_sig > 0).sum())}")

print("\nPython Significance Matrix (weights_sig):")
print(pd.DataFrame(boot.weights_sig, index=boot.labels, columns=boot.labels).round(4))
```

```{python compare-bootstrap}
r_boot_sig = np.array(r.boot_r["weights_sig"])
r_boot_orig = np.array(r.boot_r["weights_orig"])

# weights_orig must be identical (deterministic)
orig_diff = np.abs(r_boot_orig - boot.weights_orig).max()
print(f"weights_orig match (max diff): {orig_diff:.2e}")

# Compare sig matrices: same edges identified as significant
r_sig_mask = r_boot_sig > 0
py_sig_mask = boot.weights_sig > 0
agree = (r_sig_mask == py_sig_mask).sum()
total = r_sig_mask.size
print(f"Sig matrix agreement: {agree}/{total} edges ({100*agree/total:.1f}%)")

# Where they disagree
if agree < total:
    disagree_idx = np.argwhere(r_sig_mask != py_sig_mask)
    labels = boot.labels
    print(f"\nDisagreements ({total - agree} edges):")
    for i, j in disagree_idx:
        print(f"  {labels[i]} -> {labels[j]}: "
              f"R={'sig' if r_sig_mask[i,j] else 'ns'}, "
              f"Py={'sig' if py_sig_mask[i,j] else 'ns'}")
```

## Bootstrap Centralities

```{python py-bootstrap-cent}
cent_boot = tna.bootstrap_centralities(
    model_py,
    measures=['OutStrength', 'InStrength', 'Betweenness', 'Diffusion'],
    iter=1000,
    seed=42
)

print("Bootstrap Centrality Results (iter=1000):")
print(cent_boot.round(4))
```

## Permutation Test: R vs Python

```{r r-permutation}
n <- nrow(group_regulation)
group1_r <- group_regulation[1:(n %/% 2), ]
group2_r <- group_regulation[(n %/% 2 + 1):n, ]
model1_r <- tna(group1_r)
model2_r <- tna(group2_r)

set.seed(42)
perm_r <- permutation_test(model1_r, model2_r, iter = 1000)

cat("R Permutation Test (iter=1000):\n")
cat("  Significant edges:", sum(perm_r$edges$diffs_sig > 0), "\n")

cat("\nR diffs_sig matrix:\n")
print(round(perm_r$edges$diffs_sig, 4))
```

```{python py-permutation}
import importlib
importlib.reload(tna)

df_perm = tna.load_group_regulation()
half = df_perm.shape[0] // 2
group1 = df_perm.iloc[:half].copy()
group2 = df_perm.iloc[half:].copy()

model1_py = tna.build_model(group1)
model2_py = tna.build_model(group2)

perm_result = tna.permutation_test(model1_py, model2_py, iter=1000, seed=42)

print(f"Python Permutation Test (iter=1000):")
print(f"  Significant edges: {int((perm_result.edges['diffs_sig'] > 0).sum())}")

print("\nPython diffs_sig matrix:")
print(pd.DataFrame(
    perm_result.edges['diffs_sig'],
    index=perm_result.labels, columns=perm_result.labels
).round(4))
```

```{python compare-permutation}
r_perm_sig = np.array(r.perm_r["edges"]["diffs_sig"])
r_perm_diffs = np.array(r.perm_r["edges"]["diffs_true"])
py_perm_diffs = perm_result.edges['diffs_true']

# diffs_true must be identical (deterministic: difference of group weights)
diffs_diff = np.abs(r_perm_diffs - py_perm_diffs).max()
print(f"diffs_true match (max diff): {diffs_diff:.2e}")

# Compare sig matrices
r_sig_mask = r_perm_sig > 0
py_sig_mask = perm_result.edges['diffs_sig'] > 0
agree = (r_sig_mask == py_sig_mask).sum()
total = r_sig_mask.size
print(f"Sig matrix agreement: {agree}/{total} edges ({100*agree/total:.1f}%)")

if agree < total:
    disagree_idx = np.argwhere(r_sig_mask != py_sig_mask)
    labels = perm_result.labels
    print(f"\nDisagreements ({total - agree} edges):")
    for i, j in disagree_idx:
        print(f"  {labels[i]} -> {labels[j]}: "
              f"R={'sig' if r_sig_mask[i,j] else 'ns'}, "
              f"Py={'sig' if py_sig_mask[i,j] else 'ns'}")
```

---

# Visualization Comparison

## Network Plots

### R: Network Plot

```{r r-network-plot, fig.width=10, fig.height=10}
plot(model_r, layout = "circle")
title("R TNA Network")
```

### Python: Network Plot

```{python py-network-plot, fig.width=10, fig.height=10}
fig, ax = plt.subplots(figsize=(10, 10))
tna.plot_network(
    model_py,
    layout='circular',
    node_size='OutStrength',
    edge_threshold=0.05,
    ax=ax
)
ax.set_title('Python TNA Network', fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()
```

## Heatmaps

### R: Heatmap

```{r r-heatmap, fig.width=10, fig.height=8}
heatmap(model_r$weights,
        Rowv = NA, Colv = NA,
        col = colorRampPalette(c("white", "steelblue", "darkblue"))(100),
        scale = "none",
        margins = c(10, 10),
        main = "R: Transition Matrix Heatmap")
```

### Python: Heatmap

```{python py-heatmap, fig.width=10, fig.height=8}
fig, ax = plt.subplots(figsize=(10, 8))
tna.plot_heatmap(model_py, ax=ax, cmap='Blues')
ax.set_title('Python: Transition Matrix Heatmap', fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()
```

## Centrality Bar Charts

### R: Centrality Plot

```{r r-centrality-plot, fig.width=14, fig.height=10}
plot(cent_r, ncol = 3)
```

### Python: Centrality Plot

```{python py-centrality-plot, fig.width=14, fig.height=10}
fig = tna.plot_centralities(
    cent_py,
    measures=['OutStrength', 'InStrength', 'Betweenness',
              'Closeness', 'Clustering', 'Diffusion'],
    ncol=3
)
plt.suptitle('Python: Centrality Measures', fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
plt.show()
```

## Model Comparison Plot

```{python py-model-comparison, fig.width=16, fig.height=6}
# Compare TNA and FTNA
fig = tna.plot_comparison(
    model_py, ftna_py,
    plot_type='heatmap',
    labels=('TNA (Relative)', 'FTNA (Frequency)')
)
plt.suptitle('Model Comparison: TNA vs FTNA', fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
plt.show()
```

## Sequence Visualization

```{python py-sequence-plots, fig.width=12, fig.height=8}
# Reload fresh data (reticulate can corrupt pandas objects)
df_viz = tna.load_group_regulation()
fig = tna.plot_sequences(df_viz, plot_type='distribution')
plt.suptitle('State Distribution Over Time', fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
plt.show()
```

```{python py-frequency-plot, fig.width=10, fig.height=6}
# State frequencies (requires TNA model, not raw data)
fig = tna.plot_frequencies(model_py)
plt.suptitle('State Frequencies', fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
plt.show()
```

## Bootstrap Visualization

```{python py-bootstrap-plot, fig.width=14, fig.height=6}
# Plot bootstrap results
fig = tna.plot_bootstrap(boot, plot_type='weights')
plt.suptitle('Bootstrap Analysis: Edge Weight Stability',
             fontsize=14, fontweight='bold', y=1.02)
plt.tight_layout()
plt.show()
```

## Network with Confidence Intervals

```{python py-network-ci-plot, fig.width=10, fig.height=10}
# Plot network with bootstrap confidence intervals
fig, ax = plt.subplots(figsize=(10, 10))
tna.plot_network_ci(boot, edge_threshold=0.05, ax=ax)
ax.set_title('Network with Bootstrap CI (alpha-coded edges)',
             fontsize=14, fontweight='bold')
plt.tight_layout()
plt.show()
```

---

# Initial Probabilities Comparison

```{python compare-inits}
r_inits = np.array(r.model_r["inits"])
py_inits = model_py.inits
states = list(model_py.labels)

print("Initial Probabilities Comparison:")
print(f"{'State':<12} {'R':>12} {'Python':>12} {'Diff':>12}")
print("-" * 50)
for i, state in enumerate(states):
    diff = abs(r_inits[i] - py_inits[i])
    print(f"{state:<12} {r_inits[i]:12.6f} {py_inits[i]:12.6f} {diff:12.2e}")

max_init_diff = np.abs(r_inits - py_inits).max()
print(f"\nMaximum initial probability difference: {max_init_diff:.2e}")
```

---

# Numerical Equivalence Summary

```{python final-summary}
print("=" * 72)
print("         COMPLETE NUMERICAL EQUIVALENCE SUMMARY")
print("=" * 72 + "\n")

summary_results = []

# TNA weights
r_w = np.array(r.model_r["weights"])
d = np.abs(r_w - model_py.weights).max()
summary_results.append(("TNA Transition Matrix", d, d < 1e-10))

# FTNA weights
r_fw = np.array(r.ftna_r["weights"])
d = np.abs(r_fw - ftna_py.weights).max()
summary_results.append(("FTNA Frequency Matrix", d, d < 1e-10))

# CTNA weights
r_cw = np.array(r.ctna_r["weights"])
d = np.abs(r_cw - ctna_py.weights).max()
summary_results.append(("CTNA Co-occurrence Matrix", d, d < 1e-10))

# Initial probabilities
d = np.abs(r_inits - py_inits).max()
summary_results.append(("Initial Probabilities", d, d < 1e-10))

# Centralities
for m in measures:
    r_vals = r_cent_data[m]
    py_vals = cent_py[m].values
    d = np.abs(r_vals - py_vals).max()
    summary_results.append((f"Centrality: {m}", d, d < 1e-6))

# Bootstrap: weights_orig (deterministic)
r_boot_orig = np.array(r.boot_r["weights_orig"])
d = np.abs(r_boot_orig - boot.weights_orig).max()
summary_results.append(("Bootstrap: weights_orig", d, d < 1e-10))

# Bootstrap: sig matrix agreement
r_bsig = np.array(r.boot_r["weights_sig"]) > 0
py_bsig = boot.weights_sig > 0
boot_agree = (r_bsig == py_bsig).mean()
summary_results.append((f"Bootstrap: sig agreement", 1 - boot_agree, boot_agree >= 0.9))

# Permutation: diffs_true (deterministic)
r_dt = np.array(r.perm_r["edges"]["diffs_true"])
d = np.abs(r_dt - perm_result.edges['diffs_true']).max()
summary_results.append(("Permutation: diffs_true", d, d < 1e-10))

# Permutation: sig matrix agreement
r_psig = np.array(r.perm_r["edges"]["diffs_sig"]) > 0
py_psig = perm_result.edges['diffs_sig'] > 0
perm_agree = (r_psig == py_psig).mean()
summary_results.append((f"Permutation: sig agreement", 1 - perm_agree, perm_agree >= 0.9))

# Print
print("Component-wise Results:")
print("-" * 72)
print(f"{'Component':<35} {'Max Difference':>15} {'Status':>15}")
print("-" * 72)
for comp, diff, equiv in summary_results:
    status = "EQUIVALENT" if equiv else "DIFFERS"
    print(f"{comp:<35} {diff:15.2e} {status:>15}")

n_equiv = sum(1 for _, _, e in summary_results if e)
n_total = len(summary_results)
all_equiv = n_equiv == n_total

print("\n" + "-" * 72)
print(f"\nOVERALL STATUS: {'ALL COMPONENTS EQUIVALENT' if all_equiv else 'SOME DIFFERENCES FOUND'}")
print(f"\nEquivalent components: {n_equiv} / {n_total}")
print("\n" + "=" * 72)
```

---

# Tolerance Analysis

```{python tolerance-analysis}
print("Tolerance Analysis:\n")
print("Components meeting each tolerance level:\n")

tolerances = [1e-15, 1e-12, 1e-10, 1e-8, 1e-6, 1e-4]
for tol in tolerances:
    n_pass = sum(1 for _, d, _ in summary_results if d < tol)
    print(f"  < {tol:.0e}: {n_pass} / {len(summary_results)} components")
```

---

# Session Information

## R Session

```{r session-info-r}
sessionInfo()
```

## Python Session

```{python session-info-py}
import sys
print(f"Python version: {sys.version}")
print(f"NumPy version: {np.__version__}")
print(f"Pandas version: {pd.__version__}")
print(f"TNA version: {tna.__version__}")

import networkx as nx
import scipy
print(f"NetworkX version: {nx.__version__}")
print(f"SciPy version: {scipy.__version__}")
```
